"use client";
import { useState, useEffect, Suspense, useCallback } from "react";
import FilterNavbar from "../../../components/website/FilterNavbar";
import CarCard from "../../../components/website/CarCard";
import HeroFeaturedCarousel from "../../../components/website/HeroFeaturedCarousel";
import Pagination from "../../../components/website/Pagination";
import { searchCars } from "../../../services/carService";
import { usePathname, useRouter, useSearchParams } from "next/navigation";
import { useLanguage } from "../../../lib/i18n/LanguageContext";

// --- Constants from Code B for Slug Mapping ---
const SLUG_TO_COUNTRY = {
  "germany": "Niemcy",
  "france": "Francja",
  "belgium": "Belgia",
  "netherlands": "Holandia",
  "italy": "Włochy",
  "australia": "Australia",
  "austria": "Austria",
  "switzerland": "Szwajcaria",
  "sweden": "Szwecja",
  "denmark": "Dania",
  "czech-republic": "Czechy",
  "slovakia": "Słowacja",
  "spain": "Hiszpania",
  "portugal": "Portugalia",
  "united-kingdom": "Wielka Brytania",
  "ireland": "Irlandia",
  "luxembourg": "Luksemburg",
  "finland": "Finlandia",
  "norway": "Norwegia",
  "iceland": "Islandia",
  "hungary": "Węgry",
  "romania": "Rumunia",
  "bulgaria": "Bułgaria",
  "croatia": "Chorwacja",
  "slovenia": "Słowenia",
  "serbia": "Serbia",
  "montenegro": "Czarnogóra",
  "north-macedonia": "Macedonia Północna",
  "albania": "Albania",
  "lithuania": "Litwa",
  "latvia": "Łotwa",
  "estonia": "Estonia",
  "belarus": "Białoruś",
  "ukraine": "Ukraina",
  "united-states": "Stany Zjednoczone",
  "canada": "Kanada",
  "japan": "Japonia",
  "south-korea": "Korea Południowa",
  "china": "Chiny",
  "united-arab-emirates": "Zjednoczone Emiraty Arabskie",
  "dubai": "Dubaj",
  "qatar": "Katar",
  "kuwait": "Kuwejt",
  "saudi-arabia": "Arabia Saudyjska",
  "oman": "Oman",
  "bahrain": "Bahrajn",
  "israel": "Izrael",
  "turkey": "Turcja",
  "kazakhstan": "Kazachstan",
  "georgia": "Gruzja",
  "armenia": "Armenia",
  "azerbaijan": "Azerbejdżan",
  "india": "Indie",
  "russia": "Rosja"
};

const SLUG_TO_ORIGIN = {
  "australia": "Australia",
  "china": "Chiny",
  "czech-republic": "Czechy",
  "france": "Francja",
  "spain": "Hiszpania",
  "netherlands": "Holandia",
  "india": "Indie",
  "japan": "Japonia",
  "canada": "Kanada",
  "south-korea": "Korea Południowa",
  "germany": "Niemcy",
  "russia": "Rosja",
  "romania": "Rumunia",
  "united-states": "Stany Zjednoczone",
  "sweden": "Szwecja",
  "united-kingdom": "Wielka Brytania",
  "italy": "Włochy"
};

const CarsContent = () => {
  const { t } = useLanguage();
  
  // Application State
  const [cars, setCars] = useState([]);
  const [totalItems, setTotalItems] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [viewMode, setViewMode] = useState("grid");
  
  // Pagination
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(12);

  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // 1. Logic to Parse URL Params into API Filters (Merged from Code B)
  const getFiltersFromUrl = useCallback(() => {
    const apiFilters = {};
    const getParam = (key) => searchParams.get(key);

    // Basic fields
    const make = getParam("make");
    const model = getParam("model");
    const type = getParam("type") || getParam("bodyType");
    const fuel = getParam("fuel");
    const transmission = getParam("transmission");
    const location = getParam("location");
    const condition = getParam("stan") || getParam("condition");
    const drivetrain = getParam("drivetrain");
    const color = getParam("color");
    const serviceHistory = getParam("serviceHistory");
    const accidentHistory = getParam("accidentHistory");

    // Map specific keys to API requirements
    if (make) apiFilters.make = make;
    if (model) apiFilters.model = model;
    if (type) apiFilters.type = type; // API usually expects 'type', UI often sends 'bodyType'
    if (fuel) apiFilters.fuel = fuel;
    if (transmission) apiFilters.transmission = transmission;
    if (location) apiFilters.location = location;
    if (condition) apiFilters.condition = condition;
    if (drivetrain) apiFilters.drivetrain = drivetrain;
    if (color) apiFilters.color = color;
    if (serviceHistory) apiFilters.serviceHistory = serviceHistory;
    if (accidentHistory) apiFilters.accidentHistory = accidentHistory;

    // Price Mapping
    const minPrice = getParam("minPrice") || getParam("priceFrom");
    const maxPrice = getParam("maxPrice") || getParam("priceTo");
    if (minPrice) apiFilters.minPrice = minPrice;
    if (maxPrice) apiFilters.maxPrice = maxPrice;

    // Year Mapping
    const yearFrom = getParam("yearFrom") || getParam("minYear") || getParam("startYear");
    const yearTo = getParam("yearTo") || getParam("maxYear") || getParam("endYear");
    if (yearFrom) apiFilters.minYear = yearFrom;
    if (yearTo) apiFilters.maxYear = yearTo;

    // Distance Mapping
    const distance = getParam("maxDistance") || getParam("distance");
    if (distance) apiFilters.maxDistance = distance;

    // --- Complex Logic: Mileage Range Parsing ---
    const mileageRange = getParam("mileageRange");
    if (mileageRange) {
      if (mileageRange.includes("+")) {
         // e.g., "100000+"
         apiFilters.minMileage = parseInt(mileageRange.replace("+", ""), 10);
      } else if (mileageRange.includes("-")) {
         const [min, max] = mileageRange.split("-");
         apiFilters.minMileage = parseInt(min, 10);
         apiFilters.maxMileage = parseInt(max, 10);
      } else {
         apiFilters.minMileage = 0;
      }
    }

    // --- Complex Logic: Engine Capacity Range Parsing ---
    const engineCapacityRange = getParam("engineCapacityRange");
    if (engineCapacityRange) {
      if (engineCapacityRange.includes("+")) {
        apiFilters.minEngineCapacity = parseInt(engineCapacityRange.replace("+", ""), 10);
      } else if (engineCapacityRange.includes("-")) {
        const [min, max] = engineCapacityRange.split("-");
        apiFilters.minEngineCapacity = parseInt(min, 10);
        apiFilters.maxEngineCapacity = parseInt(max, 10);
      }
    }

    // --- Complex Logic: Country Mapping (Slug to Name) ---
    const origin = getParam("krajPochodzenia") || getParam("origin");
    const manufacturer = getParam("krajProducenta") || getParam("countryOfManufacturer");

    if (manufacturer) {
      // Map "germany" -> "Niemcy" for API
      apiFilters.countryOfManufacturer = SLUG_TO_COUNTRY[manufacturer] || manufacturer;
    }

    if (origin) {
      // Map "germany" -> "Niemcy" for API
      apiFilters.krajPochodzenia = SLUG_TO_ORIGIN[origin] || origin;
    }

    return apiFilters;
  }, [searchParams]);

  // 2. Fetch Data (Triggered on URL Change)
  const fetchData = useCallback(async () => {
    setIsLoading(true);
    setError(null);

    try {
      const queryFilters = getFiltersFromUrl();

      // Add pagination parameters
      queryFilters.page = currentPage;
      queryFilters.limit = itemsPerPage;

      // Clean empty values before sending to API
      Object.keys(queryFilters).forEach(key => {
          if (queryFilters[key] === undefined || queryFilters[key] === "" || queryFilters[key] === null) {
            delete queryFilters[key];
          }
      });

      const response = await searchCars(queryFilters);

      let fetchedCars = [];
      let total = 0;

      // Handle different API response structures
      if (Array.isArray(response)) {
        fetchedCars = response;
        total = response.length;
      } else if (response?.cars) {
        fetchedCars = response.cars;
        total = response.total || response.cars.length;
      }

      // Optional: Client-side filter fallback for specific complex fields if API doesn't handle them perfectly
      // (Like filtering by specific origin name if API does fuzzy match)
      const originParam = queryFilters.krajPochodzenia;
      if (originParam && fetchedCars.length > 0) {
         // This ensures exact match if the API is loose, otherwise API handles it
         const filteredByOrigin = fetchedCars.filter(c => 
            !c.origin || c.origin === originParam || c.country === originParam
         );
         if(filteredByOrigin.length > 0) fetchedCars = filteredByOrigin;
      }

      setCars(fetchedCars);
      setTotalItems(total);

    } catch (err) {
      console.error("Error fetching cars:", err);
      setError("Failed to load cars. Please try again.");
      setCars([]);
    } finally {
      setIsLoading(false);
    }
  }, [getFiltersFromUrl, currentPage, itemsPerPage]);

  useEffect(() => {
    fetchData();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, [fetchData]);


  // 3. Handle Filters from Navbar (Map UI state to URL params)
  const handleApplyFilters = (newFilters) => {
    // We map the incoming UI state to the URL parameters expected by getFiltersFromUrl
    const mappedToUrl = {
      make: newFilters.make,
      model: newFilters.model,
      // Map 'type' or 'bodyType' to a consistent URL param
      bodyType: newFilters.bodyType || newFilters.type,
      location: newFilters.location,
      maxDistance: newFilters.distance || newFilters.maxDistance,
      yearFrom: newFilters.yearFrom,
      yearTo: newFilters.yearTo,
      priceFrom: newFilters.priceFrom,
      priceTo: newFilters.priceTo,
      stan: newFilters.stan || newFilters.condition,
      fuel: newFilters.fuel,
      transmission: newFilters.transmission,
      drivetrain: newFilters.drivetrain,
      color: newFilters.color,
      serviceHistory: newFilters.serviceHistory,
      accidentHistory: newFilters.accidentHistory,
      // Store ranges as strings in URL so dropdowns can read them back easily
      mileageRange: newFilters.mileage, 
      engineCapacityRange: newFilters.engineCapacity,
      
      krajPochodzenia: newFilters.krajPochodzenia,
      krajProducenta: newFilters.krajProducenta,
    };

    const params = new URLSearchParams();

    // Add params to URL object if they exist
    Object.entries(mappedToUrl).forEach(([key, value]) => {
      if (value !== undefined && value !== "" && value !== null) {
        params.set(key, value);
      }
    });

    // Reset to page 1 on filter change
    params.set("page", "1");
    setCurrentPage(1);

    router.replace(`${pathname}?${params.toString()}`, { scroll: false });
  };

  const handlePageChange = (page) => {
    setCurrentPage(page);
    // Optional: Sync page number to URL if you want deep linking for pages
    // const params = new URLSearchParams(searchParams.toString());
    // params.set("page", page);
    // router.replace(`${pathname}?${params.toString()}`, { scroll: false });
  };

  return (
    <div className="min-h-screen bg-white dark:bg-gray-800">
      <HeroFeaturedCarousel />

      <div className="w-full sticky top-0 z-40">
        <FilterNavbar onApplyFilters={handleApplyFilters} />
      </div>

      <main className="max-w-screen-2xl mx-auto px-4 py-6">
        {/* Header: Count & View Toggle */}
        <div className="flex justify-between items-center mb-6">
            <p className="text-gray-600 dark:text-gray-300">
                Znaleziono <strong>{totalItems}</strong> samochodów
            </p>
            <div className="flex gap-2">
                <button onClick={() => setViewMode("grid")} className={`p-2 rounded ${viewMode === "grid" ? "bg-blue-100 text-blue-600" : "text-gray-500"}`}>
                   Grid
                </button>
                <button onClick={() => setViewMode("list")} className={`p-2 rounded ${viewMode === "list" ? "bg-blue-100 text-blue-600" : "text-gray-500"}`}>
                   List
                </button>
            </div>
        </div>

        {/* Results */}
        {isLoading ? (
          <div className="flex justify-center py-20">
             <div className="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
          </div>
        ) : error ? (
          <div className="text-center py-10 text-red-500">{error}</div>
        ) : cars.length === 0 ? (
          <div className="text-center py-20 bg-gray-50 rounded-lg">
             <h3 className="text-xl font-semibold text-gray-700">Brak wyników</h3>
             <p className="text-gray-500">Spróbuj zmienić filtry wyszukiwania.</p>
          </div>
        ) : (
          <div className={viewMode === "grid" ? "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" : "flex flex-col gap-4"}>
             {cars.map((car) => (
                <CarCard key={car._id} car={car} viewMode={viewMode} />
             ))}
          </div>
        )}

        {/* Pagination */}
        {!isLoading && totalItems > 0 && (
           <Pagination 
             currentPage={currentPage}
             totalItems={totalItems}
             itemsPerPage={itemsPerPage}
             onPageChange={handlePageChange}
           />
        )}
      </main>
    </div>
  );
};

const Page = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <CarsContent />
    </Suspense>
  );
};

export default Page;